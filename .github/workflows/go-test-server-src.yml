name: Go - test server-src

on:
  push:
  pull_request:
    branches: [ master ]

jobs:
  test-server-src:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Run tests for server-src and enforce 85% coverage
        working-directory: ./server-src
        run: |
          set -euo pipefail
          # Run tests and write coverage report
          go test ./... -coverprofile=coverage.out -v
          echo "Coverage report:"
          go tool cover -func=coverage.out

          # Extract total coverage percentage (numeric) and enforce threshold
          coverage=$(go tool cover -func=coverage.out | awk '/^total:/ {print $3}' | sed 's/%//')
          echo "Total coverage: ${coverage}%"

          # Fail if coverage is less than 85
          awk -v cov="$coverage" 'BEGIN { if (cov+0 < 85) { print "Coverage threshold not met (" cov "% < 85%)"; exit 1 } else { print "Coverage threshold met (" cov "% >= 85%)"; exit 0 } }'
